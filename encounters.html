<head>
    <meta charset="utf-8">
    <title>Bard's Gate Random Encounter Generator</title>
    <link href="jquery-ui.min.css" rel="stylesheet">
    <link href="jquery-ui.theme.min.css" rel="stylesheet">
    <style>
    .ui-button {
    }
    .top_button {
        font-size:xx-large !important;
        font-weight: bold;
        min-width:8em !important;
        margin:.3em .5em !important;
    }
    .stat_block {
        display:block;
        margin:15px;
    }
    .title {
        font-style:x-large;
    }
    .subtitle {
        font-style:italic;
        font-size:small;
    }
    .count {
	margin-bottom:2em;
        font-style:italic;
        font-size:x-small;
    }
    </style>

</head>
<body>
<div>
    <h1 class='title'>Welcome to the Bard's Gate Random Encounter Generator.</h1>
    <h2 class='subtitle'>May Tsathogga infest with boils any Non-GMs who click below. In other words, beware spoilers!</h2>

<button class="top_button" id="All">All</button>
<button class="top_button" id="OT_D">Old Temple District (Day)</button>
<button class="top_button" id="OT_N">Drunk Encounter demo</button>
<div class="enc">

</div>
</div>

<script src="jquery.min.js"></script>
<script src="jquery-ui.min.js"></script>
<script src="encounters.js"></script>
<script>
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function roll(amount, type) {
    var count = 0;
    for (var i=0; i<amount; i++) {
        count += getRandomInt(1, type);
    }
    return count;
}

function table_roll(table) {
    var which = getRandomInt(0, table.length -1);
    return table[which];
}

function replace_markers(text) {
    var matches = text.match(/!d\[.*?]/gi);
    if (matches) {
        for (var i=0; i<matches.length; i++) {
            var split = matches[i].split('[')[1].split(/d/i);
            var dice_type = split[1];
            var minus = dice_type.indexOf('-');
            var plus = dice_type.indexOf('+');
            if (minus != -1)
                minus = parseInt(dice_type.substring(minus+1));
            else
                minus = 0;
            if (plus != -1) {
                plus = parseInt(dice_type.substring(plus+1));
            }
            else
                plus = 0;

            var count = roll(split[0], parseInt(dice_type));
            count += plus;
            count -= minus;
            text = text.replace(matches[i], count);
        }
    }
    matches = text.match(/!t\[.*?]/g);
    if (matches) {
        for (var i=0; i<matches.length; i++) {
            var table_name = matches[i].split('[')[1].split(']')[0];
            text = text.replace(matches[i], table_roll(t[table_name]));
        }
    }
    return text;
}

function select_item(entry) {
    if (entry.extra) {
        var choice = getRandomInt(1, entry.extra.total);
        // choice = 1; //greg remove, only here for testing
        for (var i=0; i<entry.extra.chances.length; i++) {
            if (choice >= entry.extra.chances[i].min && choice <= entry.extra.chances[i].max) {
                if (entry.extra.chances[i].append) {
                    var stats;
                    var text = entry.name +": ";
                    if (entry.stats) {
                        if (entry.extra.chances[i].stats)
                            stats = entry.stats.concat(entry.extra.chances[i].stats);
                        else
                            stats = entry.stats
                    } else {
                        stats = entry.extra.chances[i].stats;
                    }
                    if (entry.text) {
                        text = text+entry.text;
                    }
                    if (entry.extra.chances[i].text) {
                        if (entry.text)
                            text +=" ";
                        text = text+entry.extra.chances[i].text;
                    }
                    return [text, stats];
                }
                else {
                    var stats;
                    if (entry.extra.chances[i].stats)
                        stats = entry.extra.chances[i].stats;
                    else
                        stats = entry.stats;
                    return [entry.name+": "+entry.extra.chances[i].text, stats];
                }
            }
        }
    }

    return [entry.name+": "+entry.text, entry.stats];
}

function render_stat_blocks(block_list) {
    var text = "";
    for (var i=0; i<block_list.length; i++)
        text += "<DIV class=stat_block>"+stat_blocks[block_list[i]]+"</DIV>";
    return text;
}

function generate_encounter() {
    var debug = false; // force to use last entry in table for debugging purposes.
    var table = enc[$(this).attr('id')];
    var which = getRandomInt(0, table.length -1);
    //debug = true; // only for debugging, breaks normal usage. Do not commit with this uncommented.
    if (debug == true) {
        console.log("forcing to use latest entry for debugging purposes. remove this!!!");
        which = table.length - 1;
    }
    /* for debugging if tables have undefined entries...
    for (var i=0; i<table.length-1; i++) {
        if (table[i] == undefined)
            console.log("error at " +i);
    }
    */
    var item = select_item(table[which]);

    var text = replace_markers(item[0]);
    if (item[1]) {
        text += render_stat_blocks(item[1]);
    }
    $('.enc').html(text);
}
    
function onReady()
{
    $('.top_button').button().click(generate_encounter);
    // create enc.all list that includes all encounters
    for (var key in e)
        enc.All.push(e[key]);
};
$(document).ready(onReady);
</script>
</body>

